import{a as nt}from"./chunk-OQOYMZNY.js";import{a as _}from"./chunk-5NBA5GWV.js";import"./chunk-BYXBJQAS.js";import{a as it}from"./chunk-APDG2UCO.js";import{e as D,f as W}from"./chunk-P3XNZYJ6.js";import{B as X,D as Y,E as tt,F as et,R as ot,S as at,b as T,e as A,f as j,g as L,h as R,i as G,j as V,k as z,l as H,o as K,p as $,s as Z,t as J,u as Q}from"./chunk-Q7QCMHQW.js";import{b as F,m as w,o as E}from"./chunk-33ZGYKW3.js";import"./chunk-CARY4E7O.js";import{$c as q,Hb as e,Ib as o,Jb as O,Qb as f,Sb as y,Xc as B,Yc as N,ac as i,cb as l,cc as m,d as S,da as g,db as u,e as k,lc as U,mc as I,na as M,oa as b,ub as C,yb as c}from"./chunk-KCGDNXPD.js";var v=class{id_empresa=1;tem_arquivo="N";pasta="";pagina=0;tamPagina=50;contador="S";orderby="";sharp=!1};function st(r,n){r&1&&(e(0,"mat-label",12),i(1,"Upload Cancelado Pelo Usu\xE1rio. "),o())}function mt(r,n){if(r&1&&(e(0,"tr")(1,"td")(2,"div",16)(3,"mat-label",17),i(4),U(5,"zeroFill"),o()()(),e(6,"td")(7,"div",16)(8,"mat-label",17),i(9),o()()(),e(10,"td")(11,"div",16)(12,"mat-label",17),i(13),o()()(),e(14,"td")(15,"div",18)(16,"mat-label",17),i(17),o()()(),e(18,"td")(19,"div",18)(20,"mat-label",17),i(21),o()()(),e(22,"td")(23,"div",16)(24,"mat-label",17),i(25),o()()(),e(26,"td")(27,"div",16)(28,"mat-label",17),i(29),o()()()()),r&2){let t=n.$implicit,a=n.index;l(4),m("",I(5,7,a+1)," "),l(5),m("",t.id_paf," "),l(4),m("",t.id," "),l(4),m("",t.pasta_arquivo," "),l(4),m("",t.nome_arquivo," "),l(4),m("",t.handle?"Sim":"N\xE3o"," "),l(4),m("",t.status_upload," ")}}function pt(r,n){if(r&1&&(e(0,"table",13)(1,"tr",14)(2,"th"),i(3,"Seq"),o(),e(4,"th"),i(5,"Paf"),o(),e(6,"th"),i(7,"Contrato"),o(),e(8,"th"),i(9,"Pasta"),o(),e(10,"th"),i(11,"Arquivo"),o(),e(12,"th"),i(13,"Existe"),o(),e(14,"th"),i(15,"Status"),o()(),C(16,mt,30,9,"tr",15),o()),r&2){let t=y();l(16),c("ngForOf",t.getContratosFiltrados())}}var P=class r{constructor(n,t,a,s,h){this.globalService=n;this.formBuilder=t;this.router=a;this.appSnackBar=s;this.contratoSrv=h;this.formulario=t.group({caminho:[{value:""}]}),this.setValue()}inscricaoContratos;pastaOk=!1;filtroPasta=!0;progress=0;formulario;arquivosLocais=[];lsContratos=[];controlePaginas=new _(0,0);tamPagina=3;isUploading=!1;isCancelando=!1;isFiltroExiste=!1;botoesOn=!1;ngOnInit(){this.inicio()}ngOnDestroy(){this.inscricaoContratos?.unsubscribe()}onHome(){this.router.navigate([""])}setValue(n=""){this.formulario.setValue({caminho:n})}onUpload(){return S(this,null,function*(){if(this.lsContratos.filter(t=>t.handle).length===0){this.appSnackBar.openWarningnackBar("Nenhum Arquivo Apto Para Upload.","OK");return}if(this.lsContratos.length===0){this.appSnackBar.openWarningnackBar("Nenhum Arquivo Para Upload.","OK");return}this.isUploading=!0,this.botoesOn=!1;try{for(let t=0;t<this.getContratosFiltrados().length;t++){let a=this.getContratosFiltrados()[t].handle;if(!a)continue;let s=yield a.getFile();if(yield this.UploadFile(this.getContratosFiltrados()[t].id_paf,this.getContratosFiltrados()[t],s),this.isCancelando)break}}finally{this.processado(),this.botoesOn=!1}})}UploadFile(n,t,a){let s=!1;return new Promise((h,d)=>{this.contratoSrv.uploadPaf(n,a).subscribe({next:p=>{p.type===F.UploadProgress?(t.status_upload=Math.round(100*p.loaded/p.total).toString()+"%",!s&&this.isCancelando&&(s=!0,this.appSnackBar.openWarningnackBar("Upload Cancelado pelo Usu\xE1rio.","OK"))):p.type===F.Response&&(t.status_upload="Enviado Com Sucesso",h())},error:p=>{t.status_upload="Erro no Upload",this.appSnackBar.openFailureSnackBar(`Erro No UpLoad ${p.error.tabela} - ${p.error.erro} - ${p.error.message}`,"OK"),d(p)}})})}onCancelar(){this.isCancelando=!0,this.isUploading||this.onHome()}getContratos(n=2){let t=new v;t.id_empresa=this.globalService.getEmpresa().id,this.filtroPasta?t.pasta=this.formulario.get("caminho")?.value:t.pasta="",n==1?t.contador="S":(t.contador="N",t.pagina=0,t.tamPagina=this.tamPagina),this.inscricaoContratos=this.contratoSrv.getContratos_DetParametro_Det_Paf(t).subscribe({next:a=>{n==2?(this.lsContratos=a,console.log("Contratos para Upload:",this.lsContratos),this.lsContratos.forEach(s=>{let h=this.arquivosLocais.find(d=>d.name.trim()==s.nome_arquivo.trim());h&&(s.handle=h,s.status_upload="Aguardando Upload")}),this.botoesOn=!0):(this.controlePaginas=new _(this.tamPagina,a.total==0?1:a.total),this.getContratos())},error:a=>{console.log("erro ->",a),this.lsContratos=[],this.controlePaginas=new _(this.tamPagina,0)}})}selecionarPasta(){return S(this,null,function*(){let n=yield window.showDirectoryPicker();this.arquivosLocais=[];try{for(var t=k(n.values()),a,s,h;a=!(s=yield t.next()).done;a=!1){let d=s.value;d.kind==="file"&&this.arquivosLocais.push(d)}}catch{h=[s]}finally{try{a&&(s=t.return)&&(yield s.call(t))}finally{if(h)throw h[0]}}return this.setValue(n.name),this.arquivosLocais.length===0?(this.appSnackBar.openFailureSnackBar("A Pasta Selecionada Est\xE1 Vazia.","Fechar"),this.botoesOn=!1):(this.pastaOk=!0,this.botoesOn=!0,this.isCancelando=!1,this.getContratos(1)),{dirHandle:n}})}onClickFiltro(){return this.isFiltroExiste=!this.isFiltroExiste,this.isFiltroExiste}onClickPasta(){if(!this.pastaOk){this.appSnackBar.openFailureSnackBar("Defina Uma Pasta V\xE1lida Para Continuar.","OK");return}return this.filtroPasta?(this.filtroPasta=!1,this.getContratos(1),this.isFiltroExiste=!1,"Filtrar Pasta"):(this.filtroPasta=!0,this.isFiltroExiste=!1,this.getContratos(1),"Remover Filtro Pasta")}textoFiltro(){return this.filtroPasta?"Remover Filtro Pasta":"Filtrar Pasta"}textoFiltroExiste(){return this.isFiltroExiste?"Todos":'Existe "SIM"'}inicio(){this.isCancelando=!1,this.isUploading=!1,this.pastaOk=!1,this.arquivosLocais=[],this.lsContratos=[],this.setValue("")}processado(){this.isUploading=!1,this.pastaOk=!1}getContratosFiltrados(){return this.isFiltroExiste?this.lsContratos.filter(n=>n.handle):this.lsContratos}static \u0275fac=function(t){return new(t||r)(u(D),u(V),u(w),u(W),u(nt))};static \u0275cmp=M({type:r,selectors:[["app-upload-paf"]],decls:34,vars:8,consts:[[1,"toolbar-alinhada"],[1,"example-spacer"],[1,"button-container"],["mat-raised-button","","color","#FFFFFF",3,"click","disabled"],["mat-raised-button","","color","accent",3,"click"],["class","cancelado",4,"ngIf"],["autocomplete","off",1,"form-container",3,"formGroup"],[1,"col-med-1"],["appearance","outline",1,"col-max"],["matInput","","formControlName","caminho"],["mat-icon-button","","matSuffix","","matTooltip","Limpar sele\xE7\xE3o",3,"click"],["class","Browse_Lanc",4,"ngIf"],[1,"cancelado"],[1,"Browse_Lanc"],[1,"coluna-cabec"],[4,"ngFor","ngForOf"],[1,"alinha_centro"],[1,"Browse_Lanc_td"],[1,"alinha_esquerda"]],template:function(t,a){t&1&&(e(0,"div",0)(1,"mat-toolbar")(2,"span",1)(3,"mat-label"),i(4,"Upload De Arquivos Do PAF"),o()(),e(5,"div",2)(6,"button",3),f("click",function(){return a.onClickFiltro()}),e(7,"mat-icon"),i(8,"filter"),o(),i(9),o(),e(10,"button",3),f("click",function(){return a.onClickPasta()}),e(11,"mat-icon"),i(12,"search"),o(),i(13),o(),e(14,"button",3),f("click",function(){return a.onUpload()}),e(15,"mat-icon"),i(16,"check"),o(),i(17," Upload "),o(),e(18,"button",4),f("click",function(){return a.onCancelar()}),e(19,"mat-icon"),i(20,"cancel"),o(),i(21," Cancelar "),o()()()(),e(22,"div"),C(23,st,2,0,"mat-label",5),o(),e(24,"form",6)(25,"div",7)(26,"mat-form-field",8)(27,"mat-label"),i(28,"Arquivo"),o(),O(29,"input",9),e(30,"button",10),f("click",function(){return a.selecionarPasta()}),e(31,"mat-icon"),i(32,"search"),o()()()()(),C(33,pt,17,1,"table",11)),t&2&&(l(6),c("disabled",!a.botoesOn),l(3),m(" ",a.textoFiltroExiste()," "),l(),c("disabled",!a.botoesOn),l(3),m(" ",a.textoFiltro()," "),l(),c("disabled",!a.botoesOn),l(9),c("ngIf",a.isCancelando),l(),c("formGroup",a.formulario),l(9),c("ngIf",a.getContratosFiltrados().length>0))},dependencies:[B,N,L,T,A,j,R,G,K,$,Z,et,tt,X,Y,J,Q,it],styles:[".content[_ngcontent-%COMP%]{height:95%;overflow:auto}tr[_ngcontent-%COMP%]:nth-child(2n){background-color:#f2f2aa}tr[_ngcontent-%COMP%]:hover{background-color:#caa99d}.form-container[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;margin:20px}.dialog-header[_ngcontent-%COMP%]{display:flex;justify-content:end;align-items:right;padding:1em;border-bottom:1px solid #ccc;background-color:#f5f5f5;position:sticky;top:0;z-index:1}.mat-dialog-container[_ngcontent-%COMP%], .mat-form-field[_ngcontent-%COMP%], .mat-label[_ngcontent-%COMP%], .mat-input-element[_ngcontent-%COMP%], .mat-select-value[_ngcontent-%COMP%], .mat-option[_ngcontent-%COMP%], .mat-error[_ngcontent-%COMP%], .mat-button[_ngcontent-%COMP%], .mat-toolbar[_ngcontent-%COMP%]{font-size:13px}.button-container[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:10px;padding:1em;border-top:1px solid #ccc}.cancelado[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:10px;padding:1em;border-top:1px solid #ccc;color:red;font-size:medium}"]})};var ct=[{path:"",redirectTo:"upload-paf",pathMatch:"full"},{path:"upload-paf",component:P}],x=class r{static \u0275fac=function(t){return new(t||r)};static \u0275mod=b({type:r});static \u0275inj=g({imports:[E.forChild(ct),E]})};var lt=class r{static \u0275fac=function(t){return new(t||r)};static \u0275mod=b({type:r});static \u0275inj=g({imports:[q,x,z,H,ot,at]})};export{lt as UploadPafModule};
